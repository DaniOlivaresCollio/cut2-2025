# Gráficos 3: Edad x sexo, segunda versión

```{r,echo=FALSE,warning=FALSE,message=FALSE}
rm(list=ls())
options(scipen = 999)

library(pacman)
p_load(
  # generacion docs 
  flextable,         # tablas personalizadas para word
  kableExtra,        # mejorar tablas
  knitr,             # generar reportes reproducibles
  officer,           # crear/modifcar documentos word o ppt
  tinytex,           # instalación mínima de LaTeX para generar PDF
  
  # importacion datos 
  haven,             # impotar/exportar datos spss, stata, sas con etiquetas
  readr,             # lectura rápida de csv
  readxl,            # leer excel 
  
  # manipulacion 
  forcats,           # manipulación de factores
  labelled,          # trabajar con variables etiquetadas
  purrr,             # programación funcional para listas y data frames
  sjlabelled,        # manejar etiquetas 
  stringr,           # manipular texto
  sjmisc,            # limpieza y descripción de datos
  
  # visualización
  ggplot2,           # visualización basado en gramática de gráficos
  ggrepel,           # etiquetas en gráficos sin superposición
  gridExtra,         # combinar gráficos en uno solo
  scales,            # controla cómo se ven los ejes en gráficos
  sjPlot,            # visualizar resultados estadísticos
  
  # análisis
  psych,             # análisis general, psicométrico
  survey,            # diseño survey encuestas complejas
  srvyr,             # diseño survey con tidy
  rlang,             # motor interno de tidyverse, para usar expresiones 
  tidyverse,
  statar,            # conectar con el lenguaje stata

  # conexion web
  curl,              # conexiones http de bajo nivel: para solucionar el problema de la api del ine
  httr               # cliente http para API
  )
```

## Cargar datos

```{r datos,message=FALSE,warning=FALSE}
load("output/data/datos-cut.Rdata")

# base survey
data_svy <- as_survey_design(data, weights = rake_wb2)
```

## Gráficos

### c01_01 x sexo x edad

```{r}
# Calcular promedios por sexo y edad
promedios_sexo_edad <- data_svy %>%
  filter(
    !is.na(c01_01),
    !is.na(sexo),
    !is.na(edad_tramos)
  ) %>%
  group_by(edad_tramos, sexo) %>%
  summarise(
    promedio = survey_mean(c01_01, na.rm = TRUE)
  )

# Graficar barras agrupadas
ggplot(promedios_sexo_edad, aes(x = edad_tramos, y = promedio, fill = sexo)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_text(
    aes(label = round(promedio, 1)),
    position = position_dodge(width = 0.8),
    vjust = 1.3,
    color = "white",
    size = 4
  ) +
  scale_fill_manual(values = c("Mujer" = "#f25f5c", "Hombre" = "#9e1b1e")) +
  labs(
    title = "Importancia de los sindicatos para: \nConseguir mejores salarios y condiciones laborales para los trabajadores",
    subtitle = "Promedio ponderado según sexo y tramo etario",
    caption = "Nota: Datos ponderados. N = 3048.",
    x = "Tramo de edad",
    y = "Promedio (escala 0-10)",
    fill = "Sexo"
  ) +
  ylim(0, 10) +
  theme_minimal()

# Guardar
ggsave("output/graph3/c01_01_sexo_edad.png", width = 10, height = 6, dpi = 300)
```

### c01_02 x sexo x edad

```{r}
# Calcular promedios por sexo y edad
promedios_c01_02 <- data_svy %>%
  filter(
    !is.na(c01_02),
    !is.na(sexo),
    !is.na(edad_tramos)
  ) %>%
  group_by(edad_tramos, sexo) %>%
  summarise(
    promedio = survey_mean(c01_02, na.rm = TRUE)
  )

# Graficar
ggplot(promedios_c01_02, aes(x = edad_tramos, y = promedio, fill = sexo)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_text(
    aes(label = round(promedio, 1)),
    position = position_dodge(width = 0.8),
    vjust = 1.3,
    color = "white",
    size = 4
  ) +
  scale_fill_manual(values = c("Mujer" = "#f25f5c", "Hombre" = "#9e1b1e")) +
  labs(
    title = "Importancia de los sindicatos para: \nReducir la desigualdad de ingresos en el país",
    subtitle = "Promedio ponderado según sexo y tramo etario",
    caption = "Nota: Datos ponderados. N = 3048.",
    x = "Tramo de edad",
    y = "Promedio (escala 0-10)",
    fill = "Sexo"
  ) +
  ylim(0, 10) +
  theme_minimal()

# Guardar
ggsave("output/graph3/c01_02_sexo_edad.png", width = 9, height = 6, dpi = 300)
```

### c05_02 x sexo x edad

```{r}
# Función para graficar distribución etaria dentro de cada sexo
graficar_distribucion_por_sexo <- function(data, variable_binaria, titulo, nombre_archivo) {
  # Verificar que es un objeto de tipo survey
  if (!("survey.design" %in% class(data))) {
    stop("El objeto ingresado no es un diseño de encuesta 'survey'. Asegúrate de haber usado 'as_survey_design()'.")
  }

  # Filtrar datos válidos y personas con valor 1 en la variable binaria
  data_filtrada <- data %>%
    filter(
      !is.na(sexo),
      !is.na(edad_tramos),
      !is.na(.data[[variable_binaria]])
    ) %>%
    filter(.data[[variable_binaria]] == 1)

  # Total ponderado por grupo (sexo + tramo de edad)
  acuerdo_por_grupo <- data_filtrada %>%
    group_by(sexo, edad_tramos) %>%
    summarise(
      total = survey_total(na.rm = TRUE),
      .groups = "drop"
    )

  # Total ponderado por sexo
  totales_por_sexo <- acuerdo_por_grupo %>%
    group_by(sexo) %>%
    summarise(
      total_sexo = sum(total),
      .groups = "drop"
    )

  # Calcular proporción dentro de cada sexo
  acuerdo_final <- acuerdo_por_grupo %>%
    left_join(totales_por_sexo, by = "sexo") %>%
    mutate(prop_sexo = total / total_sexo)

  # Crear gráfico
  grafico <- ggplot(acuerdo_final, aes(x = edad_tramos, y = prop_sexo, fill = sexo)) +
    geom_col(position = position_dodge(width = 0.8)) +
    geom_text(
      aes(label = scales::percent(prop_sexo, accuracy = 0.1)),
      position = position_dodge(width = 0.8),
      vjust = -0.3,
      size = 4,
      color = "black"
    ) +
    scale_fill_manual(values = c("Mujer" = "#f25f5c", "Hombre" = "#9e1b1e")) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                       expand = expansion(mult = c(0, 0.1))) +
    labs(
      title = titulo,
      subtitle = "Porcentaje por tramo etario y sexo",
      caption = "Nota: Datos ponderados. Proporción que responde De acuerdo (4) o Muy de acuerdo (5). N = 3048.",
      x = "Tramo de edad",
      y = "Porcentaje",
      fill = "Sexo"
    ) +
    theme_minimal()

  # Guardar gráfico
  ggsave(
    filename = paste0("output/graph3/", nombre_archivo, ".png"),
    plot = grafico,
    width = 9,
    height = 6,
    dpi = 300
  )

  # Devolver el gráfico si quieres visualizarlo en consola
  return(grafico)
}
```

```{r}
# Graficar con función
graficar_distribucion_por_sexo(
  data = data_svy,
  variable_binaria = "c05_02_acuerdo",
  titulo = "Acuerdo con: Una de las principales razones de la alta desigualdad en Chile \nes que los dueños de las empresas pagan poco a sus trabajadores",
  nombre_archivo = "c05_02_sexo_edad"
)
```

### c05_03 x sexo x edad

```{r}
# Graficar con función
graficar_distribucion_por_sexo(
  data = data_svy,
  variable_binaria = "c05_03_acuerdo",
  titulo = "Acuerdo con: El alto nivel de vida de los dueños de las empresas es resultado \nde lo poco que pagan a sus trabajadores",
  nombre_archivo = "c05_03_sexo_edad"
)
```

### c06_02 x sexo x edad

```{r}
# Graficar con función
graficar_distribucion_por_sexo(
  data = data_svy,
  variable_binaria = "c06_02_acuerdo",
  titulo = "Acuerdo con: Apoyaría una reforma para crear un sistema solidario de reparto \nsi eso permite subir las pensiones",
  nombre_archivo = "c06_02_sexo_edad"
)
```

### c07_01 x sexo x edad

```{r}
# Graficar con función
graficar_distribucion_por_sexo(
  data = data_svy,
  variable_binaria = "c07_01_acuerdo",
  titulo = "Acuerdo con: Aumentar los impuestos a los más ricos para financiar \nprogramas sociales",
  nombre_archivo = "c07_01_sexo_edad"
)
```

### c07_03 x sexo x edad

```{r}
# Graficar con función
graficar_distribucion_por_sexo(
  data = data_svy,
  variable_binaria = "c07_03_acuerdo",
  titulo = "Acuerdo con: Implementar leyes para que los sindicatos tengan más poder \nde negociación",
  nombre_archivo = "c07_03_sexo_edad"
)
```

### c07_04 x sexo x edad

```{r}
# Graficar con función
graficar_distribucion_por_sexo(
  data = data_svy,
  variable_binaria = "c07_04_acuerdo",
  titulo = "Acuerdo con: Redistribuir las riquezas desde quienes tienen más recursos \nhacia quienes tienen menos recursos",
  nombre_archivo = "c07_04_sexo_edad"
)
```

### c07_05 x sexo x edad

```{r}
# Graficar con función
graficar_distribucion_por_sexo(
  data = data_svy,
  variable_binaria = "c07_05_acuerdo",
  titulo = "Acuerdo con: Promover la igualdad entre hombres y mujeres",
  nombre_archivo = "c07_05_sexo_edad"
)
```

### c07_06 x sexo x edad

```{r}
# Graficar con función
graficar_distribucion_por_sexo(
  data = data_svy,
  variable_binaria = "c07_06_acuerdo",
  titulo = "Acuerdo con: Garantizar la educación universitaria pública y gratuita",
  nombre_archivo = "c07_06_sexo_edad"
)
```

### pol_id x sexo x edad

```{r}
# Calcular proporciones por sexo y edad
pol_id_sexo_edad <- data_svy %>%
  filter(
    !is.na(sexo),
    !is.na(edad_tramos),
    !is.na(pol_id)
  ) %>%
  group_by(edad_tramos, sexo, pol_id) %>%
  summarise(prop = survey_mean(na.rm = TRUE)) %>%
  ungroup()

# Graficar
grafico <- ggplot(pol_id_sexo_edad, aes(x = edad_tramos, y = prop, fill = pol_id)) +
  geom_col(position = "fill", color = "white") +
  geom_text(
    aes(label = ifelse(prop > 0.04, paste0(round(prop * 100, 1), "%"), "")),  # mostrar solo si es >4%
    position = position_fill(vjust = 0.5),
    color = "white",
    size = 3.5
  ) +
  facet_wrap(~sexo) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_fill_manual(
    values = c(
      "Izquierda" = "#ff5651",
      "Centro" = "#ca0000",
      "Derecha" = "#9e1b1e",
      "No se identifica" = "#6f0000"
  )) +
  labs(
    title = "Identificación política",
    subtitle = "Porcentajes según sexo y tramo etario",
    x = "Tramo de edad",
    y = "Porcentaje",
    fill = "Identificación política",
    caption = "Nota: Datos ponderados. N = 3048."
  ) +
  theme_minimal()

grafico

ggsave("output/graph3/pol_id_sexo_edad.png", plot = grafico, width = 10, height = 6, dpi = 300)
```

### politizado x sexo x edad

```{r}
# Filtrar casos válidos que están de acuerdo
data_filtrada <- data_svy %>%
  filter(
    !is.na(sexo),
    !is.na(edad_tramos),
    !is.na(politizado)
  ) %>%
  filter(politizado == 1)

# Total de personas por sexo y tramo etario
acuerdo_por_grupo <- data_filtrada %>%
  group_by(sexo, edad_tramos) %>%
  summarise(total = survey_total(na.rm = TRUE), .groups = "drop")

# Total de personas por sexo
totales_por_sexo <- acuerdo_por_grupo %>%
  group_by(sexo) %>%
  summarise(total_sexo = sum(total), .groups = "drop")

# Calcular proporción dentro de cada sexo
acuerdo_final <- acuerdo_por_grupo %>%
  left_join(totales_por_sexo, by = "sexo") %>%
  mutate(
    prop_sexo = total / total_sexo
  )

ggplot(acuerdo_final, aes(x = edad_tramos, y = prop_sexo, fill = sexo)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_text(
    aes(label = scales::percent(prop_sexo, accuracy = 0.1)),
    position = position_dodge(width = 0.8),
    vjust = -0.5,
    color = "black",
    size = 4
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                       expand = expansion(mult = c(0, 0.1))) +
  scale_fill_manual(values = c("Mujer" = "#f25f5c", "Hombre" = "#9e1b1e")) +
  labs(
    title = "Porcentaje de personas politizadas",
    subtitle = "Según sexo y tramo etario",
    x = "Tramo de edad",
    y = "Porcentaje de personas politizadas",
    fill = "Sexo",
    caption = "Nota: Datos ponderados. Politización definida como hablar de política (4–5) y confiar en partidos (3–5). N = 3048."
  ) +
  theme_minimal()

ggsave("output/graph3/politizado_sexo_edad.png", width = 10, height = 6, dpi = 300)
```

### clases 1 x sexo x edad

```{r}
# Calcular proporciones por sexo y edad
class1_sexo_edad <- data_svy %>%
  filter(
    !is.na(sexo),
    !is.na(edad_tramos),
    !is.na(wrightclass1_reduced)
  ) %>%
  group_by(edad_tramos, sexo, wrightclass1_reduced) %>%
  summarise(prop = survey_mean(na.rm = TRUE)) %>%
  ungroup()

# Graficar
grafico <- ggplot(class1_sexo_edad, aes(x = edad_tramos, y = prop, fill = wrightclass1_reduced)) +
  geom_col(position = "fill", color = "white") +
  geom_text(
    aes(label = ifelse(prop > 0.04, paste0(round(prop * 100, 1), "%"), "")),  # mostrar solo si es >4%
    position = position_fill(vjust = 0.5),
    color = "white",
    size = 3.5
  ) +
  facet_wrap(~sexo) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_fill_manual(
    values = c(
      "1. Formal workers" = "#6f0000",
      "2. Informal workers" = "#9e1b1e",
      "3. Informal self-employed" = "#ca0000",
      "4. Experts" = "#ff5651",
      "5. Supervisors" ="#b23a48",
      "6. Managers" = "#8c1d40",
      "7. Petty bourgeoisie" = "#d1eaf3",
      "8. Small employers" = "#0f6481",
      "9. Employers" = "#083342"
  )) +
  labs(
    title = "Clases",
    subtitle = "Porcentajes según sexo y tramo etario",
    x = "Tramo de edad",
    y = "Porcentaje",
    fill = "Clases",
    caption = "Nota: Datos ponderados. N = 3048."
  ) +
  theme_minimal()

grafico

ggsave("output/graph3/class1_sexo_edad.png", plot = grafico, width = 10, height = 6, dpi = 300)
```

### clases 2 x sexo x edad

```{r}
# Calcular proporciones por sexo y edad
class2_sexo_edad <- data_svy %>%
  filter(
    !is.na(sexo),
    !is.na(edad_tramos),
    !is.na(wrightclass2_reduced)
  ) %>%
  group_by(edad_tramos, sexo, wrightclass2_reduced) %>%
  summarise(prop = survey_mean(na.rm = TRUE)) %>%
  ungroup()

# Graficar
grafico <- ggplot(class2_sexo_edad, aes(x = edad_tramos, y = prop, fill = wrightclass2_reduced)) +
  geom_col(position = "fill", color = "white") +
  geom_text(
    aes(label = ifelse(prop > 0.04, paste0(round(prop * 100, 1), "%"), "")),  # mostrar solo si es >4%
    position = position_fill(vjust = 0.5),
    color = "white",
    size = 3.5
  ) +
  facet_wrap(~sexo) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_fill_manual(
    values = c(
      "1. Formal workers" = "#6f0000",
      "2. Informal workers" = "#9e1b1e",
      "3. Informal self-employed" = "#ca0000",
      "4. Experts" = "#ff5651",
      "5. Supervisors" ="#b23a48",
      "6. Managers" = "#8c1d40",
      "7. Petty bourgeoisie" = "#d1eaf3",
      "8. Small employers" = "#0f6481",
      "9. Capitalists" = "#083342"
  )) +
  labs(
    title = "Clases 2",
    subtitle = "Porcentajes según sexo y tramo etario",
    x = "Tramo de edad",
    y = "Porcentaje",
    fill = "Clases 2",
    caption = "Nota: Datos ponderados. N = 3048."
  ) +
  theme_minimal()

grafico

ggsave("output/graph3/class2_sexo_edad.png", plot = grafico, width = 10, height = 6, dpi = 300)
```
