# Gráficos 2: Edad x sexo, primera versión

```{r,echo=FALSE,warning=FALSE,message=FALSE}
rm(list=ls())
options(scipen = 999)

library(pacman)
p_load(
  # generacion docs 
  flextable,         # tablas personalizadas para word
  kableExtra,        # mejorar tablas
  knitr,             # generar reportes reproducibles
  officer,           # crear/modifcar documentos word o ppt
  tinytex,           # instalación mínima de LaTeX para generar PDF
  
  # importacion datos 
  haven,             # impotar/exportar datos spss, stata, sas con etiquetas
  readr,             # lectura rápida de csv
  readxl,            # leer excel 
  
  # manipulacion 
  forcats,           # manipulación de factores
  labelled,          # trabajar con variables etiquetadas
  purrr,             # programación funcional para listas y data frames
  sjlabelled,        # manejar etiquetas 
  stringr,           # manipular texto
  sjmisc,            # limpieza y descripción de datos
  
  # visualización
  ggplot2,           # visualización basado en gramática de gráficos
  ggrepel,           # etiquetas en gráficos sin superposición
  gridExtra,         # combinar gráficos en uno solo
  scales,            # controla cómo se ven los ejes en gráficos
  sjPlot,            # visualizar resultados estadísticos
  
  # análisis
  psych,             # análisis general, psicométrico
  survey,            # diseño survey encuestas complejas
  srvyr,             # diseño survey con tidy
  rlang,             # motor interno de tidyverse, para usar expresiones 
  tidyverse,
  statar,            # conectar con el lenguaje stata

  # conexion web
  curl,              # conexiones http de bajo nivel: para solucionar el problema de la api del ine
  httr               # cliente http para API
  )
```

## Cargar datos

```{r datos,message=FALSE,warning=FALSE}
load("output/data/datos-cut.Rdata")

# base survey
data_svy <- as_survey_design(data, weights = rake_wb2)
```

## Gráficos

### c01_01 x sexo x edad

```{r}
# Calcular promedios por sexo y edad
promedios_sexo_edad <- data_svy %>%
  filter(
    !is.na(c01_01),
    !is.na(sexo),
    !is.na(edad_tramos)
  ) %>%
  group_by(edad_tramos, sexo) %>%
  summarise(
    promedio = survey_mean(c01_01, na.rm = TRUE)
  )

# Graficar barras agrupadas
ggplot(promedios_sexo_edad, aes(x = edad_tramos, y = promedio, fill = sexo)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_text(
    aes(label = round(promedio, 1)),
    position = position_dodge(width = 0.8),
    vjust = 1.3,
    color = "white",
    size = 4
  ) +
  scale_fill_manual(values = c("Mujer" = "#f25f5c", "Hombre" = "#9e1b1e")) +
  labs(
    title = "Importancia de los sindicatos para: \nConseguir mejores salarios y condiciones laborales para los trabajadores",
    subtitle = "Promedio ponderado según sexo y tramo etario",
    caption = "Nota: Datos ponderados. N = 3048.",
    x = "Tramo de edad",
    y = "Promedio (escala 0-10)",
    fill = "Sexo"
  ) +
  ylim(0, 10) +
  theme_minimal()

# Guardar
ggsave("output/graph2/c01_01_sexo_edad.png", width = 9, height = 6, dpi = 300)
```

### c01_02 x sexo x edad

```{r}
# Calcular promedios por sexo y edad
promedios_c01_02 <- data_svy %>%
  filter(
    !is.na(c01_02),
    !is.na(sexo),
    !is.na(edad_tramos)
  ) %>%
  group_by(edad_tramos, sexo) %>%
  summarise(
    promedio = survey_mean(c01_02, na.rm = TRUE)
  )

# Graficar
ggplot(promedios_c01_02, aes(x = edad_tramos, y = promedio, fill = sexo)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_text(
    aes(label = round(promedio, 1)),
    position = position_dodge(width = 0.8),
    vjust = 1.3,
    color = "white",
    size = 4
  ) +
  scale_fill_manual(values = c("Mujer" = "#f25f5c", "Hombre" = "#9e1b1e")) +
  labs(
    title = "Importancia de los sindicatos para: \nReducir la desigualdad de ingresos en el país",
    subtitle = "Promedio ponderado según sexo y tramo etario",
    caption = "Nota: Datos ponderados. N = 3048.",
    x = "Tramo de edad",
    y = "Promedio (escala 0-10)",
    fill = "Sexo"
  ) +
  ylim(0, 10) +
  theme_minimal()

# Guardar
ggsave("output/graph2/c01_02_sexo_edad.png", width = 9, height = 6, dpi = 300)
```

### c05_02 x sexo x edad

```{r}
# Calcular proporciones por sexo y edad
acuerdo_sexo_edad <- data_svy %>%
  filter(
    !is.na(sexo),
    !is.na(edad_tramos),
    !is.na(c05_02_acuerdo)
  ) %>%
  group_by(edad_tramos, sexo) %>%
  summarise(
    prop_acuerdo = survey_mean(c05_02_acuerdo, na.rm = TRUE)
  )

# Graficar: barras separadas por sexo (cada grupo suma 100%)
ggplot(acuerdo_sexo_edad, aes(x = edad_tramos, y = prop_acuerdo, fill = sexo)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_text(
    aes(label = scales::percent(prop_acuerdo, accuracy = 0.1)),
    position = position_dodge(width = 0.8),
    vjust = 1.3,
    size = 4,
    color = "white"
  ) +
  scale_fill_manual(values = c("Mujer" = "#f25f5c", "Hombre" = "#9e1b1e")) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), expand = expansion(mult = c(0, 0.1))) +
  labs(
    title = "Acuerdo con: Una de las principales razones de la alta desigualdad en Chile \nes que los dueños de las empresas pagan poco a sus trabajadores",
    subtitle = "Porcentaje según sexo y tramo etario",
    caption = "Nota: Datos ponderados. Proporción que responde De acuerdo (4) o Muy de acuerdo (5). N = 3048.",
    x = "Tramo de edad",
    y = "Porcentaje",
    fill = "Sexo"
  ) +
  theme_minimal()

# Guardar gráfico
ggsave("output/graph2/c05_02_sexo_edad.png", width = 9, height = 6, dpi = 300)
```

### c05_03 x sexo x edad

```{r}
# Calcular proporciones por sexo y edad
acuerdo_sexo_edad <- data_svy %>%
  filter(
    !is.na(sexo),
    !is.na(edad_tramos),
    !is.na(c05_03_acuerdo)
  ) %>%
  group_by(edad_tramos, sexo) %>%
  summarise(
    prop_acuerdo = survey_mean(c05_03_acuerdo, na.rm = TRUE)
  )

# Graficar
ggplot(acuerdo_sexo_edad, aes(x = edad_tramos, y = prop_acuerdo, fill = sexo)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_text(
    aes(label = scales::percent(prop_acuerdo, accuracy = 0.1)),
    position = position_dodge(width = 0.8),
    vjust = 1.3,
    color = "white",
    size = 4
  ) +
  scale_fill_manual(values = c("Mujer" = "#f25f5c", "Hombre" = "#9e1b1e")) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Acuerdo con: El alto nivel de vida de los dueños de las empresas es resultado \nde lo poco que pagan a sus trabajadores",
    subtitle = "Porcentaje según sexo y tramo etario",
    caption = "Nota: Datos ponderados. Proporción que responde De acuerdo (4) o Muy de acuerdo (5). N = 3048.",
    x = "Tramo de edad",
    y = "Porcentaje de acuerdo",
    fill = "Sexo"
  ) +
  theme_minimal()

# Guardar gráfico
ggsave("output/graph2/c05_03_sexo_edad.png", width = 9, height = 6, dpi = 300)
```

### c06_02 x sexo x edad

```{r}
# Calcular proporciones por sexo y edad
acuerdo_sexo_edad <- data_svy %>%
  filter(
    !is.na(sexo),
    !is.na(edad_tramos),
    !is.na(c06_02_acuerdo)
  ) %>%
  group_by(edad_tramos, sexo) %>%
  summarise(
    prop_acuerdo = survey_mean(c06_02_acuerdo, na.rm = TRUE)
  )

# Graficar
ggplot(acuerdo_sexo_edad, aes(x = edad_tramos, y = prop_acuerdo, fill = sexo)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_text(
    aes(label = scales::percent(prop_acuerdo, accuracy = 0.1)),
    position = position_dodge(width = 0.8),
    vjust = 1.3,
    color = "white",
    size = 4
  ) +
  scale_fill_manual(values = c("Mujer" = "#f25f5c", "Hombre" = "#9e1b1e")) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Acuerdo con: Apoyaría una reforma para crear un sistema solidario de reparto \nsi eso permite subir las pensiones",
    subtitle = "Porcentaje según sexo y tramo etario",
    caption = "Nota: Datos ponderados. Proporción que responde De acuerdo (4) o Muy de acuerdo (5). N = 3048.",
    x = "Tramo de edad",
    y = "Porcentaje de acuerdo",
    fill = "Sexo"
  ) +
  theme_minimal()

# Guardar gráfico
ggsave("output/graph2/c06_02_sexo_edad.png", width = 9, height = 6, dpi = 300)
```

### c07_01 x sexo x edad

```{r}
# Calcular proporciones por sexo y edad
acuerdo_sexo_edad <- data_svy %>%
  filter(
    !is.na(sexo),
    !is.na(edad_tramos),
    !is.na(c07_01_acuerdo)
  ) %>%
  group_by(edad_tramos, sexo) %>%
  summarise(
    prop_acuerdo = survey_mean(c07_01_acuerdo, na.rm = TRUE)
  )

# Graficar
ggplot(acuerdo_sexo_edad, aes(x = edad_tramos, y = prop_acuerdo, fill = sexo)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_text(
    aes(label = scales::percent(prop_acuerdo, accuracy = 0.1)),
    position = position_dodge(width = 0.8),
    vjust = 1.3,
    color = "white",
    size = 4
  ) +
  scale_fill_manual(values = c("Mujer" = "#f25f5c", "Hombre" = "#9e1b1e")) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Acuerdo con: Aumentar los impuestos a los más ricos para financiar \nprogramas sociales",
    subtitle = "Porcentaje según sexo y tramo etario",
    caption = "Nota: Datos ponderados. Proporción que responde De acuerdo (4) o Muy de acuerdo (5). N = 3048.",
    x = "Tramo de edad",
    y = "Porcentaje de acuerdo",
    fill = "Sexo"
  ) +
  theme_minimal()

# Guardar gráfico
ggsave("output/graph2/c07_01_sexo_edad.png", width = 9, height = 6, dpi = 300)
```

### c07_03 x sexo x edad

```{r}
# Calcular proporciones por sexo y edad
acuerdo_sexo_edad <- data_svy %>%
  filter(
    !is.na(sexo),
    !is.na(edad_tramos),
    !is.na(c07_03_acuerdo)
  ) %>%
  group_by(edad_tramos, sexo) %>%
  summarise(
    prop_acuerdo = survey_mean(c07_03_acuerdo, na.rm = TRUE)
  )

# Graficar
ggplot(acuerdo_sexo_edad, aes(x = edad_tramos, y = prop_acuerdo, fill = sexo)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_text(
    aes(label = scales::percent(prop_acuerdo, accuracy = 0.1)),
    position = position_dodge(width = 0.8),
    vjust = 1.3,
    color = "white",
    size = 4
  ) +
  scale_fill_manual(values = c("Mujer" = "#f25f5c", "Hombre" = "#9e1b1e")) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Acuerdo con: Implementar leyes para que los sindicatos tengan más poder \nde negociación",
    subtitle = "Porcentaje según sexo y tramo etario",
    caption = "Nota: Datos ponderados. Proporción que responde De acuerdo (4) o Muy de acuerdo (5). N = 3048.",
    x = "Tramo de edad",
    y = "Porcentaje de acuerdo",
    fill = "Sexo"
  ) +
  theme_minimal()

# Guardar gráfico
ggsave("output/graph2/c07_03_sexo_edad.png", width = 9, height = 6, dpi = 300)
```

### c07_04 x sexo x edad

```{r}
# Calcular proporciones por sexo y edad
acuerdo_sexo_edad <- data_svy %>%
  filter(
    !is.na(sexo),
    !is.na(edad_tramos),
    !is.na(c07_04_acuerdo)
  ) %>%
  group_by(edad_tramos, sexo) %>%
  summarise(
    prop_acuerdo = survey_mean(c07_04_acuerdo, na.rm = TRUE)
  )

# Graficar
ggplot(acuerdo_sexo_edad, aes(x = edad_tramos, y = prop_acuerdo, fill = sexo)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_text(
    aes(label = scales::percent(prop_acuerdo, accuracy = 0.1)),
    position = position_dodge(width = 0.8),
    vjust = 1.3,
    color = "white",
    size = 4
  ) +
  scale_fill_manual(values = c("Mujer" = "#f25f5c", "Hombre" = "#9e1b1e")) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Acuerdo con: Redistribuir las riquezas desde quienes tienen más recursos \nhacia quienes tienen menos recursos",
    subtitle = "Porcentaje según sexo y tramo etario",
    caption = "Nota: Datos ponderados. Proporción que responde De acuerdo (4) o Muy de acuerdo (5). N = 3048.",
    x = "Tramo de edad",
    y = "Porcentaje de acuerdo",
    fill = "Sexo"
  ) +
  theme_minimal()

# Guardar gráfico
ggsave("output/graph2/c07_04_sexo_edad.png", width = 9, height = 6, dpi = 300)
```

### c07_05 x sexo x edad

```{r}
# Calcular proporciones por sexo y edad
acuerdo_sexo_edad <- data_svy %>%
  filter(
    !is.na(sexo),
    !is.na(edad_tramos),
    !is.na(c07_05_acuerdo)
  ) %>%
  group_by(edad_tramos, sexo) %>%
  summarise(
    prop_acuerdo = survey_mean(c07_05_acuerdo, na.rm = TRUE)
  )

# Graficar
ggplot(acuerdo_sexo_edad, aes(x = edad_tramos, y = prop_acuerdo, fill = sexo)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_text(
    aes(label = scales::percent(prop_acuerdo, accuracy = 0.1)),
    position = position_dodge(width = 0.8),
    vjust = 1.3,
    color = "white",
    size = 4
  ) +
  scale_fill_manual(values = c("Mujer" = "#f25f5c", "Hombre" = "#9e1b1e")) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Acuerdo con: Promover la igualdad entre hombres y mujeres",
    subtitle = "Porcentaje según sexo y tramo etario",
    caption = "Nota: Datos ponderados. Proporción que responde De acuerdo (4) o Muy de acuerdo (5). N = 3048.",
    x = "Tramo de edad",
    y = "Porcentaje de acuerdo",
    fill = "Sexo"
  ) +
  theme_minimal()

# Guardar gráfico
ggsave("output/graph2/c07_05_sexo_edad.png", width = 9, height = 6, dpi = 300)
```

### c07_06 x sexo x edad

```{r}
# Calcular proporciones por sexo y edad
acuerdo_sexo_edad <- data_svy %>%
  filter(
    !is.na(sexo),
    !is.na(edad_tramos),
    !is.na(c07_06_acuerdo)
  ) %>%
  group_by(edad_tramos, sexo) %>%
  summarise(
    prop_acuerdo = survey_mean(c07_06_acuerdo, na.rm = TRUE)
  )

# Graficar
ggplot(acuerdo_sexo_edad, aes(x = edad_tramos, y = prop_acuerdo, fill = sexo)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_text(
    aes(label = scales::percent(prop_acuerdo, accuracy = 0.1)),
    position = position_dodge(width = 0.8),
    vjust = 1.3,
    color = "white",
    size = 4
  ) +
  scale_fill_manual(values = c("Mujer" = "#f25f5c", "Hombre" = "#9e1b1e")) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Acuerdo con: Garantizar la educación universitaria pública y gratuita",
    subtitle = "Porcentaje según sexo y tramo etario",
    caption = "Nota: Datos ponderados. Proporción que responde De acuerdo (4) o Muy de acuerdo (5). N = 3048.",
    x = "Tramo de edad",
    y = "Porcentaje de acuerdo",
    fill = "Sexo"
  ) +
  theme_minimal()

# Guardar gráfico
ggsave("output/graph2/c07_06_sexo_edad.png", width = 9, height = 6, dpi = 300)
```

