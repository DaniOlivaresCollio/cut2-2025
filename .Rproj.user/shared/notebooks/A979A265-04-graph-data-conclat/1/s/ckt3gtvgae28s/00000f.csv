"0","# Función para graficar distribución etaria dentro de cada sexo"
"0","graficar_distribucion_por_sexo <- function(data, variable_binaria, titulo, nombre_archivo) {"
"0","  # Verificar que es un objeto de tipo survey"
"0","  if (!(""survey.design"" %in% class(data))) {"
"0","    stop(""El objeto ingresado no es un diseño de encuesta 'survey'. Asegúrate de haber usado 'as_survey_design()'."")"
"0","  }"
"0",""
"0","  # Filtrar datos válidos y personas con valor 1 en la variable binaria"
"0","  data_filtrada <- data %>%"
"0","    filter("
"0","      !is.na(sexo),"
"0","      !is.na(edad_tramos),"
"0","      !is.na(.data[[variable_binaria]])"
"0","    ) %>%"
"0","    filter(.data[[variable_binaria]] == 1)"
"0",""
"0","  # Total ponderado por grupo (sexo + tramo de edad)"
"0","  acuerdo_por_grupo <- data_filtrada %>%"
"0","    group_by(sexo, edad_tramos) %>%"
"0","    summarise("
"0","      total = survey_total(na.rm = TRUE),"
"0","      .groups = ""drop"""
"0","    )"
"0",""
"0","  # Total ponderado por sexo"
"0","  totales_por_sexo <- acuerdo_por_grupo %>%"
"0","    group_by(sexo) %>%"
"0","    summarise("
"0","      total_sexo = sum(total),"
"0","      .groups = ""drop"""
"0","    )"
"0",""
"0","  # Calcular proporción dentro de cada sexo"
"0","  acuerdo_final <- acuerdo_por_grupo %>%"
"0","    left_join(totales_por_sexo, by = ""sexo"") %>%"
"0","    mutate(prop_sexo = total / total_sexo)"
"0",""
"0","  # Crear gráfico"
"0","  grafico <- ggplot(acuerdo_final, aes(x = edad_tramos, y = prop_sexo, fill = sexo)) +"
"0","    geom_col(position = position_dodge(width = 0.8)) +"
"0","    geom_text("
"0","      aes(label = scales::percent(prop_sexo, accuracy = 0.1)),"
"0","      position = position_dodge(width = 0.8),"
"0","      vjust = -0.3,"
"0","      size = 4,"
"0","      color = ""black"""
"0","    ) +"
"0","    scale_fill_manual(values = c(""Mujer"" = ""#f25f5c"", ""Hombre"" = ""#9e1b1e"")) +"
"0","    scale_y_continuous(labels = scales::percent_format(accuracy = 1),"
"0","                       expand = expansion(mult = c(0, 0.1))) +"
"0","    labs("
"0","      title = titulo,"
"0","      subtitle = ""Porcentaje por tramo etario y sexo"","
"0","      caption = ""Nota: Datos ponderados. Proporción que responde De acuerdo (4) o Muy de acuerdo (5). N = 3048."","
"0","      x = ""Tramo de edad"","
"0","      y = ""Porcentaje"","
"0","      fill = ""Sexo"""
"0","    ) +"
"0","    theme_minimal()"
"0",""
"0","  # Guardar gráfico"
"0","  ggsave("
"0","    filename = paste0(""output/graph3/"", nombre_archivo, "".png""),"
"0","    plot = grafico,"
"0","    width = 9,"
"0","    height = 6,"
"0","    dpi = 300"
"0","  )"
"0",""
"0","  # Devolver el gráfico si quieres visualizarlo en consola"
"0","  return(grafico)"
"0","}"
