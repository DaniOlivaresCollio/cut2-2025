"0","plot_binary_by <- function("
"0","  data,                # poner la data svy"
"0","  var,                 # variable binaria 0/1"
"0","  x_var,               # categórica para eje X"
"0","  fill_var = NULL,     # categórica para fill (opcional)"
"0","  title,               # título del gráfico"
"0","  subtitle,            # subtítulo del gráfico"
"0",""
"0","  # ---- Etiquetas ----"
"0","  x_label = NULL,"
"0","  y_label = ""Porcentaje"","
"0","  fill_label = NULL,"
"0","  caption = NULL,"
"0",""
"0","  # ---- Porcentajes ----"
"0","  label_accuracy = 0.1,"
"0","  axis_accuracy  = 1,"
"0",""
"0","  # ---- Estilo y escala ----"
"0","  expand_y = TRUE,"
"0","  palette = NULL,"
"0","  dodge_width = 0.8,"
"0","  single_fill = ""#3b82f6"",     # color único cuando no hay fill_var"
"0","  color_by_x = FALSE,          # si TRUE, colorea por categoría de x_var"
"0","  text_color = ""white"",        # color del texto de las etiquetas"
"0",""
"0","  # ---- Texto eje X ----"
"0","  x_text_angle = 0,"
"0","  x_text_hjust = NULL,"
"0","  x_text_vjust = NULL,"
"0","  x_text_size  = 8,"
"0",""
"0","  # ---- Guardado ----"
"0","  file   = NULL,"
"0","  width  = 10,"
"0","  height = 6,"
"0","  dpi    = 300,"
"0",""
"0","  # ---- Comportamiento ----"
"0","  show = TRUE,"
"0","  save = TRUE,"
"0","  return_df = FALSE,"
"0","  ..."
"0",") {"
"0","  var_name   <- as_name(ensym(var))"
"0","  x_name     <- as_name(ensym(x_var))"
"0","  fill_quo   <- enquo(fill_var)"
"0","  has_fill   <- !(quo_is_null(fill_quo) || quo_is_missing(fill_quo) || is.null(get_expr(fill_quo)))"
"0",""
"0","  x_label    <- x_label    %||% as_label(enquo(x_var))"
"0","  if (has_fill) fill_label <- fill_label %||% as_label(fill_quo)"
"0",""
"0","  # ---- Datos ----"
"0","  if (has_fill) {"
"0","    df <- data %>%"
"0","      dplyr::filter("
"0","        !is.na({{ x_var }}),"
"0","        !is.na({{ fill_var }}),"
"0","        !is.na({{ var }})"
"0","      ) %>%"
"0","      dplyr::group_by({{ x_var }}, {{ fill_var }}) %>%"
"0","      dplyr::summarise(prop = srvyr::survey_mean({{ var }}, na.rm = TRUE), .groups = ""drop"")"
"0",""
"0","    N_unw <- data %>%"
"0","      dplyr::filter("
"0","        !is.na({{ x_var }}),"
"0","        !is.na({{ fill_var }}),"
"0","        !is.na({{ var }})"
"0","      ) %>%"
"0","      dplyr::summarise(n = dplyr::n()) %>% dplyr::pull(n)"
"0","  } else {"
"0","    df <- data %>%"
"0","      dplyr::filter("
"0","        !is.na({{ x_var }}),"
"0","        !is.na({{ var }})"
"0","      ) %>%"
"0","      dplyr::group_by({{ x_var }}) %>%"
"0","      dplyr::summarise(prop = srvyr::survey_mean({{ var }}, na.rm = TRUE), .groups = ""drop"")"
"0",""
"0","    N_unw <- data %>%"
"0","      dplyr::filter("
"0","        !is.na({{ x_var }}),"
"0","        !is.na({{ var }})"
"0","      ) %>%"
"0","      dplyr::summarise(n = dplyr::n()) %>% dplyr::pull(n)"
"0","  }"
"0",""
"0","  if (is.null(caption)) {"
"0","    caption <- paste0("
"0","      ""Nota: Datos ponderados. Proporción que responde De acuerdo (4) o Muy de acuerdo (5). N = "","
"0","      format(N_unw, big.mark = ""."", decimal.mark = "","")"
"0","    )"
"0","  }"
"0",""
"0","  y_scale <- if (isTRUE(expand_y)) {"
"0","    ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = axis_accuracy),"
"0","                                expand = ggplot2::expansion(mult = c(0, 0.1)))"
"0","  } else {"
"0","    ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = axis_accuracy))"
"0","  }"
"0",""
"0","  # Defaults razonables para hjust/vjust según ángulo"
"0","  .hjust <- if (is.null(x_text_hjust)) { if (x_text_angle == 0) 0.5 else 1 } else x_text_hjust"
"0","  .vjust <- if (is.null(x_text_vjust)) { if (x_text_angle == 90) 0.5 else 1 } else x_text_vjust"
"0",""
"0","  # ---- Plot ----"
"0","  if (has_fill) {"
"0","    p <- ggplot2::ggplot(df, ggplot2::aes(x = {{ x_var }}, y = prop, fill = {{ fill_var }})) +"
"0","      ggplot2::geom_col(position = ggplot2::position_dodge(width = dodge_width)) +"
"0","      ggplot2::geom_text("
"0","        ggplot2::aes(label = scales::percent(prop, accuracy = label_accuracy)),"
"0","        position = ggplot2::position_dodge(width = dodge_width),"
"0","        vjust = 1.3, size = 2.5, color = ""white"""
"0","      ) +"
"0","      (if (is.null(palette)) ggplot2::scale_fill_discrete() else ggplot2::scale_fill_manual(values = palette)) +"
"0","      y_scale +"
"0","      ggplot2::labs("
"0","        title = title, subtitle = subtitle, caption = caption,"
"0","        x = x_label, y = y_label, fill = fill_label"
"0","      ) +"
"0","      ggplot2::theme_minimal() +"
"0","      ggplot2::theme(axis.text.x = ggplot2::element_text(angle = x_text_angle, hjust = .hjust, vjust = .vjust, size = x_text_size))"
"0","} else {"
"0","    if (isTRUE(color_by_x)) {"
"0","      p <- ggplot2::ggplot(df, ggplot2::aes(x = {{ x_var }}, y = prop, fill = {{ x_var }})) +"
"0","        ggplot2::geom_col() +"
"0","        (if (is.null(palette)) ggplot2::scale_fill_discrete(guide = ""none"")"
"0","         else ggplot2::scale_fill_manual(values = palette, guide = ""none"")) +"
"0","        y_scale +"
"0","        ggplot2::geom_text("
"0","          ggplot2::aes(label = scales::percent(prop, accuracy = label_accuracy)),"
"0","          vjust = 1.3, size = 2.5, color = text_color"
"0","        ) +"
"0","        ggplot2::labs("
"0","          title = title, subtitle = subtitle, caption = caption,"
"0","          x = x_label, y = y_label"
"0","        ) +"
"0","        ggplot2::theme_minimal() +"
"0","        ggplot2::theme("
"0","          axis.text.x = ggplot2::element_text(angle = x_text_angle, hjust = .hjust, vjust = .vjust, size = x_text_size)"
"0","        )"
"0","    } else {"
"0","      p <- ggplot2::ggplot(df, ggplot2::aes(x = {{ x_var }}, y = prop)) +"
"0","        ggplot2::geom_col(fill = single_fill) +"
"0","        y_scale +"
"0","        ggplot2::geom_text("
"0","          ggplot2::aes(label = scales::percent(prop, accuracy = label_accuracy)),"
"0","          vjust = 1.3, size = 2.5, color = text_color"
"0","        ) +"
"0","        ggplot2::labs("
"0","          title = title, subtitle = subtitle, caption = caption,"
"0","          x = x_label, y = y_label"
"0","        ) +"
"0","        ggplot2::theme_minimal() +"
"0","        ggplot2::theme("
"0","          axis.text.x = ggplot2::element_text(angle = x_text_angle, hjust = .hjust, vjust = .vjust, size = x_text_size)"
"0","        )"
"0","    }"
"0","  }"
"0",""
"0","  if (isTRUE(show)) print(p)"
"0",""
"0","  # ---- Guardado ----"
"0","  if (isTRUE(save)) {"
"0","    if (is.null(file)) {"
"0","      if (!dir.exists(""output/graph4"")) dir.create(""output/graph4"", recursive = TRUE)"
"0","      if (has_fill) {"
"0","        file <- file.path(""output/graph4"", paste0(var_name, ""_by_"", x_name, ""_and_"", as_name(get_expr(fill_quo)), "".png""))"
"0","      } else {"
"0","        file <- file.path(""output/graph4"", paste0(var_name, ""_by_"", x_name, "".png""))"
"0","      }"
"0","    } else {"
"0","      dir_to_make <- dirname(file)"
"0","      if (!dir.exists(dir_to_make)) dir.create(dir_to_make, recursive = TRUE)"
"0","    }"
"0","    ggplot2::ggsave(filename = file, plot = p, width = width, height = height, dpi = dpi, ...)"
"0","  }"
"0",""
"0","  if (isTRUE(return_df)) {"
"0","    return(invisible(list(plot = p, data = df)))"
"0","  } else {"
"0","    return(invisible(p))"
"0","  }"
"0","}"
"0",""
