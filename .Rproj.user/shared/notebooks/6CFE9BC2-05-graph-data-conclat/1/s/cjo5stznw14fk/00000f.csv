"0","plot_binary_by <- function("
"0","  data,                # poner la data svy"
"0","  var,                 # variable binaria 0/1"
"0","  x_var,               # categórica para eje X"
"0","  fill_var,            # categórica para fill"
"0","  title,               # título del gráfico"
"0","  subtitle,            # subtítulo del gráfico"
"0",""
"0","  # ---- Etiquetas ----"
"0","  x_label = NULL,"
"0","  y_label = ""Porcentaje"","
"0","  fill_label = NULL,"
"0","  caption = NULL,"
"0",""
"0","  # ---- Porcentajes ----"
"0","  label_accuracy = 0.1,"
"0","  axis_accuracy  = 1,"
"0",""
"0","  # ---- Estilo y escala ----"
"0","  expand_y = TRUE,"
"0","  palette = NULL,"
"0","  dodge_width = 0.8,"
"0",""
"0","  # ---- Texto eje X (nuevo) ----"
"0","  x_text_angle = 0,           # 0, 45, 90 típicamente"
"0","  x_text_hjust = NULL,        # si NULL, se decide según ángulo"
"0","  x_text_vjust = NULL,        # si NULL, se decide según ángulo"
"0","  x_text_size  = 8,          # tamaño de fuente"
"0",""
"0","  # ---- Guardado ----"
"0","  file   = NULL,"
"0","  width  = 10,"
"0","  height = 6,"
"0","  dpi    = 300,"
"0",""
"0","  # ---- Comportamiento ----"
"0","  show = TRUE,"
"0","  save = TRUE,"
"0","  return_df = FALSE,"
"0","  ..."
"0",") {"
"0","  var_name   <- as_name(ensym(var))"
"0","  x_name     <- as_name(ensym(x_var))"
"0","  fill_name  <- as_name(ensym(fill_var))"
"0","  x_label    <- x_label    %||% as_label(enquo(x_var))"
"0","  fill_label <- fill_label %||% as_label(enquo(fill_var))"
"0",""
"0","  df <- data %>%"
"0","    filter("
"0","      !is.na({{ x_var }}),"
"0","      !is.na({{ fill_var }}),"
"0","      !is.na({{ var }})"
"0","    ) %>%"
"0","    group_by({{ x_var }}, {{ fill_var }}) %>%"
"0","    summarise(prop = survey_mean({{ var }}, na.rm = TRUE),"
"0","              .groups = ""drop"")"
"0",""
"0","  N_unw <- data %>%"
"0","    filter("
"0","      !is.na({{ x_var }}),"
"0","      !is.na({{ fill_var }}),"
"0","      !is.na({{ var }})"
"0","    ) %>%"
"0","    summarise(n = n()) %>% pull(n)"
"0",""
"0","  if (is.null(caption)) {"
"0","    caption <- paste0("
"0","      ""Nota: Datos ponderados. Proporción que responde De acuerdo (4) o Muy de acuerdo (5). N = "","
"0","      format(N_unw, big.mark = ""."", decimal.mark = "","")"
"0","    )"
"0","  }"
"0",""
"0","  y_scale <- if (isTRUE(expand_y)) {"
"0","    scale_y_continuous(labels = percent_format(accuracy = axis_accuracy),"
"0","                       expand = expansion(mult = c(0, 0.1)))"
"0","  } else {"
"0","    scale_y_continuous(labels = percent_format(accuracy = axis_accuracy))"
"0","  }"
"0",""
"0","  # Defaults razonables para hjust/vjust según ángulo"
"0","  .hjust <- if (is.null(x_text_hjust)) {"
"0","    if (x_text_angle == 0) 0.5 else 1"
"0","  } else x_text_hjust"
"0",""
"0","  .vjust <- if (is.null(x_text_vjust)) {"
"0","    if (x_text_angle == 90) 0.5 else 1"
"0","  } else x_text_vjust"
"0",""
"0","  p <- ggplot(df, aes(x = {{ x_var }}, y = prop, fill = {{ fill_var }})) +"
"0","    geom_col(position = position_dodge(width = dodge_width)) +"
"0","    geom_text("
"0","      aes(label = percent(prop, accuracy = label_accuracy)),"
"0","      position = position_dodge(width = dodge_width),"
"0","      vjust = 1.3,"
"0","      size = 2.5,"
"0","      color = ""white"""
"0","    ) +"
"0","    (if (is.null(palette)) scale_fill_discrete() else scale_fill_manual(values = palette)) +"
"0","    y_scale +"
"0","    labs("
"0","      title = title,"
"0","      subtitle = subtitle,"
"0","      caption = caption,"
"0","      x = x_label,"
"0","      y = y_label,"
"0","      fill = fill_label"
"0","    ) +"
"0","    theme_minimal() +"
"0","    theme("
"0","      axis.text.x = element_text(angle = x_text_angle, hjust = .hjust, vjust = .vjust, size = x_text_size)"
"0","    )"
"0",""
"0","  if (isTRUE(show)) print(p)"
"0",""
"0","  if (isTRUE(save)) {"
"0","    if (is.null(file)) {"
"0","      if (!dir.exists(""output/graph4"")) dir.create(""output/graph4"", recursive = TRUE)"
"0","      file <- file.path(""output/graph4"", paste0(var_name, ""_by_"", x_name, ""_and_"", fill_name, "".png""))"
"0","    } else {"
"0","      dir_to_make <- dirname(file)"
"0","      if (!dir.exists(dir_to_make)) dir.create(dir_to_make, recursive = TRUE)"
"0","    }"
"0","    ggsave(filename = file, plot = p, width = width, height = height, dpi = dpi, ...)"
"0","  }"
"0",""
"0","  if (isTRUE(return_df)) {"
"0","    return(invisible(list(plot = p, data = df)))"
"0","  } else {"
"0","    return(invisible(p))"
"0","  }"
"0","}"
